<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>jex test</title>
    <script src="escodegen.browser.js"></script>
    <script src="peg.js"></script>
    <script>
      function compile(){
        var src = document.getElementById('src').value;
        var dst = document.getElementById('dst');
        try{
          var ast = jexParser.parse(src);
          dst.value = escodegen.generate(ast);
          return true;
        }catch(e){
          dst.value = e.stack;
          return false;
        }
      }
      
      function run(){
        var dst = document.getElementById('dst').value;
        var s = document.createElement('script');
        s.innerHTML = dst;
        document.head.appendChild(s);
        document.head.removeChild(s);
      }
      onload = function(){
        var ALTPEGJS = 'jex.pegjs';
        var log = console.log;
        console.log = function(){
          var args = [].slice.call(arguments);
          log.apply(console, args);
          
          var domlog = document.getElementById('log');
          args.forEach(function(arg){
            var v = '';
            if(arg == null) v = 'null';
            else if(typeof arg === 'function') v = arg.toString(); 
            else v = JSON.stringify(arg, null, '  ');
            domlog.value += v + '\n'; 
          });
          domlog.scrollTop = 99999999;
        };
        var xml = new XMLHttpRequest();
        xml.onreadystatechange = function(){
          if(xml.readyState === 4)if(xml.status === 0 || (xml.status/100 | 0) === 2){
            window.jexParser = peg.generate(xml.responseText, {chache: true});
            var editor = document.getElementById('src');

            window.onkeydown = function(e){
              if(e.ctrlKey || e.metaKey){
                if(e.keyCode === 83 || e.keyCode === 13){
                  e.preventDefault();
                  compile() && run();
                  return false;
                }
              }
            };
            editor.value = function(){/*
function es5func(a, b){
  return a + b;
}
# altJsFunc(c, d){
  return es5func(c + d, 100);
}
var func2 = #(a){console.log(a);};
func2(altJsFunc(5, 10));
// 演算子オーバーロード
var obj = {
  value: 100,
  '+': #(v){
    @value += v;
    return this;
  },
  
  '-': #(v){
    @value -= v;
    return @;
  },
  
  '<': #(elm){
    @children.push(elm);
    return @;
  },
  children: []

};

// 使うときは演算子のあとに:
obj <: 'child';
console.log(obj +: 100 -: 50);

# Pos(x, y){
  @x = x;
  @y = y;
}

Pos.prototype = {
  '-': #(p){
    @x -= p.x;
    @y -= p.y;
    return @;
  },
  
  '<': #(p){
    return @len() < p.len();
  },
  
  '<=': #(p){
    return @len() <= p.len();
  },
  
  len: function(){
    return Math.sqrt(@x * @x + @y * @y);
  },
};

var p1 = new Pos(1, 2);
var p2 = new Pos(3, 4);

console.log(p1 <: p2);
p2 -: p1 -: p1;
console.log(p1 <=: p2);

*/}.toString().replace(/.*\/\*|\*\/.*/g, '');
            compile() && run();
            document.getElementById('run').onclick = function(){compile()&&run();};
          }
        };
        xml.open('GET', ALTPEGJS);
        xml.send();
      };
    </script>
    <style media="screen">
      .editor{
        width: 48%;
        height: 50vh;
      }
      
      #log {
        width: 95%;
        height: 20vh;
      }
      
      .flex-between{
        display: flex;
        justify-content:space-around;
      }
    </style>
  </head>
  <body>
    <h1>AltJS のテスト</h1>
    <ul>
      <li># - function</li>
      <li>@ - this</li>
      <li>[operator]: - use overloaded operator (演算子オーバーロードの使用)</li>
      <li>obj['operator'] = #(right){/* なんか計算 */ return this;} - define operator overload (演算子オーバーロードの定義)</li>
    </ul>
    <p>
      <button type="button" name="button" id="run">実行!</button>
    </p>
      <div class="flex-between">
        <span>altjs:</span>
        <span>コンパイル結果:</span>
      </div>
    <div>
      <textarea id="src" name="editor" class="jex editor">
      </textarea>
      <textarea id="dst" class="compiled editor">
      </textarea>
      
    </div>
    
    <div>console:
      <textarea id="log"></textarea>
    </div>
  </body>
</html>